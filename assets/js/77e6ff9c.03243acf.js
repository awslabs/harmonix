"use strict";(self.webpackChunk_aws_harmonix_on_aws_website=self.webpackChunk_aws_harmonix_on_aws_website||[]).push([[5616],{4188:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"integration/control-tower-and-aft","title":"AWS Control Tower and AFT","description":"Introduction","source":"@site/docs/integration/control-tower-and-aft.md","sourceDirName":"integration","slug":"/integration/control-tower-and-aft","permalink":"/docs/integration/control-tower-and-aft","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Integration","permalink":"/docs/category/integration"},"next":{"title":"Git","permalink":"/docs/integration/git"}}');var a=t(74848),r=t(28453);const i={sidebar_position:1},s="AWS Control Tower and AFT",c={},l=[{value:"Introduction",id:"introduction",level:3},{value:"Architecture",id:"architecture",level:2},{value:"Installing AWS Control Tower and AFT",id:"installing-aws-control-tower-and-aft",level:2},{value:"Integrating Harmonix on AWS to AFT",id:"integrating-harmonix-on-aws-to-aft",level:2},{value:"Introduction",id:"introduction-1",level:3},{value:"Step 1: Create Harmonix Management Account",id:"step-1-create-harmonix-management-account",level:3},{value:"Step 2: Deploy Harmonix",id:"step-2-deploy-harmonix",level:3},{value:"Step 3: Set up IAM Role for Application Account",id:"step-3-set-up-iam-role-for-application-account",level:3},{value:"Step 4: Create Application Account for Harmonix Integration",id:"step-4-create-application-account-for-harmonix-integration",level:3}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"aws-control-tower-and-aft",children:"AWS Control Tower and AFT"})}),"\n",(0,a.jsx)(e.h3,{id:"introduction",children:"Introduction"}),"\n",(0,a.jsxs)(e.p,{children:["This article will describe how to inegrate Harmonix on AWS with AWS Control Tower and AFT-",(0,a.jsx)(e.a,{href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory",children:"Account Factory for Terraform"}),"."]}),"\n",(0,a.jsx)(e.h2,{id:"architecture",children:"Architecture"}),"\n",(0,a.jsx)("p",{align:"center",children:(0,a.jsx)("img",{src:"/img/diagrams/aft-architecture.png"})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"In the above architecture, we created a seprate OU to host IAC orchestration and an account for AFT to be deployed."}),"\n",(0,a.jsxs)(e.li,{children:["We can also use the same OU to host Harmonix on AWS Platform and it's platform artifacts - this is ",(0,a.jsx)(e.strong,{children:"not"})," for workload controlled accounts"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"installing-aws-control-tower-and-aft",children:"Installing AWS Control Tower and AFT"}),"\n",(0,a.jsxs)(e.p,{children:["AWS Control Tower: ",(0,a.jsx)(e.strong,{children:"Must be deployed in your environment"}),"."]}),"\n",(0,a.jsx)(e.p,{children:"Account Factory for Terraform (AFT): Must be deployed and configured with your Control Tower environment."}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:["For setting up Control Tower, follow this ",(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/controltower/latest/userguide/setting-up.html",children:"link"}),"."]}),"\n",(0,a.jsxs)(e.li,{children:["For integrating AFT with your Control Tower environment, follow this ",(0,a.jsx)(e.a,{href:"https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft",children:"link"}),"."]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"integrating-harmonix-on-aws-to-aft",children:"Integrating Harmonix on AWS to AFT"}),"\n",(0,a.jsx)(e.h3,{id:"introduction-1",children:"Introduction"}),"\n",(0,a.jsx)(e.p,{children:'The AFT pipeline provide a process that create accounts by submitting a request to "account-requests" repository, as shown in the below diagram:'}),"\n",(0,a.jsx)("p",{align:"center",children:(0,a.jsx)("img",{src:"/img/diagrams/aft-pipeline.png"})}),"\n",(0,a.jsx)(e.p,{children:"The integration with Harmonix on AWS Platform is based on the principle of customization template - that creates a pre-baked role, that the platform / Harmonix pipeline can use to provision resources."}),"\n",(0,a.jsx)(e.h3,{id:"step-1-create-harmonix-management-account",children:"Step 1: Create Harmonix Management Account"}),"\n",(0,a.jsx)(e.p,{children:"This step is option. You can choose to deploy Harmonix in any existing account; however, we as a best practice we discourage doing so."}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["Create an AWS account within your Control Tower environment named ",(0,a.jsx)(e.code,{children:"Harmonix Management"}),". This account will host the Harmonix infrastructure."]}),"\n",(0,a.jsx)(e.li,{children:"AFT Repositories: AFT supports four repositories for account management and customizations:"}),"\n"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"account_request_repo_name: Manages new account requests."}),"\n",(0,a.jsx)(e.li,{children:"global_customizations_repo_name: Applies customizations across all AFT-created accounts."}),"\n",(0,a.jsx)(e.li,{children:"account_customizations_repo_name: Customizes specific accounts."}),"\n",(0,a.jsx)(e.li,{children:"account_provisioning_customizations_repo_name: Sets up custom non-Terraform integrations pre-account provisioning."}),"\n"]}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"Account Request:"}),"\n"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:["Add an account request for the ",(0,a.jsx)(e.code,{children:"Harmonix Management"})," account in the account_request repository."]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u2514\u2500\u2500 harmonix_account-request.tf\n"})}),"\n",(0,a.jsx)(e.p,{children:"harmonix_account-request.tf ->"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-terraform",children:'module "harmonix_account_admin" {\n  source = "./modules/aft-account-request"\n  \n  control_tower_parameters = {\n    AccountEmail              = "<email>"\n    AccountName               = "Harmonix Management"\n    ManagedOrganizationalUnit = "<ou>"\n    SSOUserEmail              = "<user-email>"\n    SSOUserFirstName          = "<first-name>"\n    SSOUserLastName           = "<last-name>"\n  }\n  \n  account_tags = {\n    "Owner"       = "<owner>"\n    "Division"    = "<division>"\n    "Environment" = "<env>"\n    "CostCenter"  = "<cost-center>"\n    "BUCode"      = "<bu-code>"\n    "Project"     = "Harmonix"\n  }\n  \n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy Harmonix Management Account to host Harmonix infrastructure"\n  }\n  \n  custom_fields = {\n    note = "This account will be used to deploy Harmonix management portal infrastructure"\n  }\n}\n'})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Push these changes to trigger account creation with AFT. Wait for completion before proceeding to Step 2."}),"\n"]}),"\n",(0,a.jsx)(e.h3,{id:"step-2-deploy-harmonix",children:"Step 2: Deploy Harmonix"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"Access: Ensure you have access to the Harmonix management account with the necessary permissions to deploy required infrastructure."}),"\n",(0,a.jsxs)(e.li,{children:["Installation: Follow Harmonix installation steps via this ",(0,a.jsx)(e.a,{href:"/docs/getting-started/deploy-the-platform",children:"link"}),"."]}),"\n"]}),"\n",(0,a.jsx)(e.h3,{id:"step-3-set-up-iam-role-for-application-account",children:"Step 3: Set up IAM Role for Application Account"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["Automation with AFT: Use AFT for automating IAM role creation (",(0,a.jsx)(e.strong,{children:"HarmonixExecutionRole"}),") in the Application account, allowing Harmonix Management account to manage resources."]}),"\n",(0,a.jsx)(e.li,{children:"Customization Code:"}),"\n"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:["Specify this as a template (",(0,a.jsx)(e.strong,{children:"Harmonix_INTEGRATION"}),") in the Account Customization AFT repository."]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-customizations\n\u2502   \u2514\u2500\u2500 Harmonix_INTEGRATION\n\u2502       \u251c\u2500\u2500 api_helpers\n\u2502       \u2502   \u251c\u2500\u2500 post-api-helpers.sh\n\u2502       \u2502   \u251c\u2500\u2500 pre-api-helpers.sh\n\u2502       \u2502   \u2514\u2500\u2500 python\n\u2502       \u2502       \u2514\u2500\u2500 requirements.txt\n\u2502       \u2514\u2500\u2500 terraform\n\u2502           \u251c\u2500\u2500 aft-providers.jinja\n\u2502           \u251c\u2500\u2500 backend.jinja\n\u2502           \u2514\u2500\u2500 main.tf\n"})}),"\n",(0,a.jsx)(e.p,{children:"main.tf ->"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-terraform",children:'data "aws_ssm_parameter" "harmonix_org_id" {\n  name = "/aft/account-request/custom-fields/harmonix-org-id"\n}\n\ndata "aws_ssm_parameter" "aft_management_account_id" {\n  name = "/aft/account-request/custom-fields/harmonix-account-id"\n}\n\ndata "aws_ssm_parameter" "harmonix_pipeline_role" {\n  name = "/aft/account-request/custom-fields/harmonix-pipeline-role"\n}\n\ndata "aws_ssm_parameter" "harmonix_platform_role" {\n  name = "/aft/account-request/custom-fields/harmonix-platform-role"\n}\n\ndata "aws_iam_policy_document" "assume_role_policy" {\n  statement {\n    effect  = "Allow"\n\n    principals {\n      type        = "AWS"\n      identifiers = [\n        data.aws_ssm_parameter.harmonix_platform_role.value,\n        data.aws_ssm_parameter.harmonix_pipeline_role.value\n      ]\n    }\n\n    actions = ["sts:AssumeRole"]\n\n  }\n}\n\nresource "aws_iam_role" "admin_role" {\n  name               = "HarmonixExecutionRole"\n  assume_role_policy = data.aws_iam_policy_document.assume_role_policy.json\n}\n\nresource "aws_iam_role_policy_attachment" "admin_attach" {\n  role       = aws_iam_role.admin_role.name\n  policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"\n}\n'})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Push Customization Code: Update the specified account customization repository with this code."}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{alt:"Harmonix Management Account Iam role flow with Application account",src:t(14002).A+"",width:"1593",height:"513"})}),"\n",(0,a.jsx)(e.h3,{id:"step-4-create-application-account-for-harmonix-integration",children:"Step 4: Create Application Account for Harmonix Integration"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"Account Request:"}),"\n"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Create an Application account creation request tailored for Harmonix on AWS."}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u251c\u2500\u2500 harmonix_moderated_account1.tf\n\u2502       \u2514\u2500\u2500 harmonix_account-request.tf\n"})}),"\n",(0,a.jsx)(e.p,{children:"harmonix_moderated_account1.tf->"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-terraform",children:'module "harmonix_app_account_1" {\n  source = "./modules/aft-account-request"\n\n  control_tower_parameters = {\n    AccountEmail              = ""\n    AccountName               = "Harmonix Application Account 1"\n    ManagedOrganizationalUnit = "Sandbox"\n    SSOUserEmail              = ""\n    SSOUserFirstName          = ""\n    SSOUserLastName           = ""\n  }\n\n  account_tags = {\n    "Owner"       = ""\n    "Division"    = ""\n    "Environment" = ""\n    "CostCenter"  = ""\n    "BUCode"      = ""\n    "Project"     = "Harmonix"\n  }\n\n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy Harmonix Application Account 1"\n  }\n\n  custom_fields = {\n    note = "This account will be used to deploy applications from Harmonix management portal"\n    harmonix-org-id = "Harmonix_ORG_ID"\n    harmonix-account-id = "Harmonix_ACCOUNT_ID"\n    harmonix-pipeline-role = "Harmonix_PIPELINE_IAM_ROLE"\n    harmonix-platform-role = "arn:aws:iam::Harmonix_ACCOUNT_ID:role/backstage-master-role"\n  }\n\n  account_customizations_name = "Harmonix_INTEGRATION"\n}\n'})}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"Note"}),": We are using custom_fields here to inject variables that will be used by the Account Customization Harmonix_INTEGRATION template"]}),"\n",(0,a.jsx)(e.p,{children:"The actual values for these variable needs to be fetched from the Harmonix management account and Control Tower management account"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Login to the Harmonix Management account under the IAM service and Role. Copy the harmonix-pipeline-role and harmonix-platform-role"}),"\n",(0,a.jsx)(e.li,{children:"Login to the Control Tower management account. From the Control Tower service -> Organization tab, copy the Harmonix management account ID and the Organization ID that the Harmonix management account is part of."}),"\n"]}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"Completion:"}),"\n"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Push the request to the Account Request repo and wait for account creation to complete."}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["Congratulations! You have successfully set up an Application account ready for Harmonix integration. For deploying applications using Harmonix, follow this ",(0,a.jsx)(e.a,{href:"/docs/getting-started/videos",children:"link"}),"."]})]})}function m(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},14002:(n,e,t)=>{t.d(e,{A:()=>o});const o=t.p+"assets/images/opa-iam-role-9d2f00ac7dd1332f78a94abdbce4c0c2.png"},28453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>s});var o=t(96540);const a={},r=o.createContext(a);function i(n){const e=o.useContext(r);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),o.createElement(r.Provider,{value:e},n.children)}}}]);